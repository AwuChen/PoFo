<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Concentric ForceGraph</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
    #filter-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 8px;
      font-family: sans-serif;
    }
    .filter-group {
      margin-bottom: 10px;
    }
    .filter-group label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
    }
    .filter-group div {
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <div id="filter-container"></div>
  <div id="3d-graph"></div>

  <script src="https://unpkg.com/3d-force-graph"></script>
  <script>
    const entities = [
      { id: 1, name: 'URF / TX THE BOX', category: 'Forces', impact: 'High' },
      { id: 2, name: 'ART BANK', category: 'Investment', impact: 'Medium' },
      { id: 3, name: 'DONGHAI / EASTERN SEAS', category: 'Diplomacy', impact: 'Low' },
      { id: 4, name: 'MIND COUNCIL', category: 'Forces', impact: 'Medium' },
      { id: 5, name: 'QUANTUM COVE', category: 'Investment', impact: 'High' },
      { id: 6, name: 'NEON NODE', category: 'Diplomacy', impact: 'Low' }
    ];

    const links = [
      { source: 1, target: 2 },
      { source: 2, target: 3 },
      { source: 3, target: 4 },
      { source: 4, target: 5 },
      { source: 5, target: 6 },
      { source: 6, target: 1 }
    ];

    const impactRingMap = {
      'Low': 200,
      'Medium': 300,
      'High': 400
    };

    const categoryHierarchy = {
      'Forces': ['URF / TX THE BOX', 'MIND COUNCIL'],
      'Investment': ['ART BANK', 'QUANTUM COVE'],
      'Diplomacy': ['DONGHAI / EASTERN SEAS', 'NEON NODE']
    };

    const centerNode = { id: 0, name: 'CENTER', category: 'Core', impact: 'High' };

    const Graph = ForceGraph()(document.getElementById('3d-graph'))
      .nodeId('id')
      .nodeLabel('name')
      .nodeAutoColorBy('category')
      .linkDirectionalParticles(2)
      .linkDirectionalParticleWidth(2)
      .onEngineTick(() => {
        Graph.zoomToFit(400);
      });

    function polarToCartesian(radius, angleInDegrees) {
      const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
      return {
        x: radius * Math.cos(angleInRadians),
        y: radius * Math.sin(angleInRadians)
      };
    }

    function applyFilters() {
      const checkedFilters = Array.from(document.querySelectorAll('.filter-item:checked')).map(cb => cb.value);
      const checkedSubFilters = Array.from(document.querySelectorAll('.subfilter-item:checked')).map(cb => cb.value);

      const filteredNodes = entities
        .filter(d => checkedFilters.includes(d.category))
        .filter(d => checkedSubFilters.includes(d.name))
        .map((node, idx, arr) => {
          const nodesInSameRing = arr.filter(n => n.impact === node.impact);
          const angle = 360 * nodesInSameRing.findIndex(n => n.id === node.id) / nodesInSameRing.length;
          const { x, y } = polarToCartesian(impactRingMap[node.impact], angle);
          return { ...node, fx: x, fy: y };
        });

      const nodeIds = new Set(filteredNodes.map(n => n.id));
      const filteredLinks = links.filter(l => nodeIds.has(l.source) && nodeIds.has(l.target));

      Graph.graphData({
        nodes: [centerNode, ...filteredNodes],
        links: filteredLinks
      });
    }

    function createFilterUI() {
      const container = document.getElementById('filter-container');
      container.innerHTML = '';

      Object.entries(categoryHierarchy).forEach(([category, names]) => {
        const group = document.createElement('div');
        group.className = 'filter-group';

        const label = document.createElement('label');
        label.textContent = category;
        group.appendChild(label);

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'filter-item';
        checkbox.value = category;
        checkbox.checked = true;
        checkbox.addEventListener('change', applyFilters);
        group.appendChild(checkbox);

        const subGroup = document.createElement('div');
        names.forEach(name => {
          const subLabel = document.createElement('label');
          const subCheckbox = document.createElement('input');
          subCheckbox.type = 'checkbox';
          subCheckbox.className = 'subfilter-item';
          subCheckbox.value = name;
          subCheckbox.checked = true;
          subCheckbox.addEventListener('change', applyFilters);
          subLabel.appendChild(subCheckbox);
          subLabel.appendChild(document.createTextNode(name));
          subGroup.appendChild(subLabel);
        });

        group.appendChild(subGroup);
        container.appendChild(group);
      });
    }

    // INIT
    createFilterUI();
    applyFilters();
  </script>
</body>
</html>
