<!DOCTYPE html>
<html lang="en">
<head>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; position: absolute; top: 0; left: 0; z-index: 0; }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      padding: 10px;
      border-radius: 8px;
      font-family: sans-serif;
      max-height: 90vh;
      overflow-y: auto;
    }
    #controls h3 {
      margin-top: 10px;
      margin-bottom: 5px;
    }
    .filter-item {
      font-size: 16px;
      margin: 4px 0;
      cursor: pointer;
      color: #999;
      font-weight: bold;
      transition: color 0.2s;
    }
    .filter-item.active {
      color: #000;
      padding: 2px 6px;
    }
    #entityList {
      position: absolute;
      font-family: sans-serif;
      z-index: 11;
      max-height: 90vh;
      overflow-y: auto;
      display: none;
    }
    #entityList div {
      cursor: pointer;
      margin: 4px 0;
      color: #444;
      font-weight: 500;
      font-size: 15px;
    }
    #entityList div:hover {
      color: #000;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/force-graph"></script>
</head>
<body>
  <div id="controls">
    <h3>PORTFOLIO & CATEGORIES</h3>
    <div id="categoryFilters"></div>
    <h3>APPROACH & IMPACT</h3>
    <div id="impactFilters"></div>
  </div>
  <div id="entityList"></div>
  <div id="graph"></div>
  <div id="infoPopup" style="
    position: absolute;
    top: 100px;
    right: 20px;
    background: white;
    border: 1px solid #ccc;
    padding: 12px;
    border-radius: 8px;
    font-family: sans-serif;
    display: none;
    z-index: 20;
    max-width: 300px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  ">
    <strong id="popupName"></strong><br>
    <span id="popupCategory"></span><br>
    <span id="popupImpact"></span>
  </div>
<script>
  const entities = [/* entities array — same as before — truncated for brevity */];

  const impactRingMap = {
    'Strategy.Culture': 0,
    'Branding': 1,
    'Retail': 2,
    'East.West': 3,
    'Edu.Learning.Collective': 4,
    'Creative Solution': 5
  };

  const ringSpacing = 80;
  const baseRadius = 100;
  const ringColors = ['#bc6c25', '#606c38', '#283618', '#dda15e', '#7b7b7b', '#8ecae6'];
  const maxLayers = 6;

  let nodeId = 0;
  const nodes = [], links = [];

  const centerNodeId = nodeId++;
  nodes.push({ id: centerNodeId, fx: 0, fy: 0, size: 4, color: '#000000' });

  entities.forEach((entity, index) => {
    const angle = (2 * Math.PI * index) / entities.length;
    let lastNodeId = centerNodeId;

    entity.impacts.forEach(impact => {
      const ringIndex = impactRingMap[impact] ?? 0;
      const radius = baseRadius + ringIndex * ringSpacing;
      const x = radius * Math.cos(angle);
      const y = radius * Math.sin(angle);

      const thisNodeId = nodeId++;
      nodes.push({
        id: thisNodeId,
        fx: x,
        fy: y,
        name: entity.name,
        categories: entity.categories,
        impact: impact,
        radialIndex: index,
        size: 6,
        color: ringColors[ringIndex % ringColors.length]
      });

      links.push({
        source: lastNodeId,
        target: thisNodeId,
        radialIndex: index
      });

      lastNodeId = thisNodeId;
    });
  });

  const gData = { nodes, links };
  const Graph = ForceGraph()(document.getElementById('graph'))
    .graphData(gData)
    .enableNodeDrag(false)
    .linkDirectionalParticles(0)
    .linkWidth(() => 0.5)
    .linkColor(() => '#000000')
    .nodeCanvasObject((node, ctx) => {
      if (node.id === centerNodeId) {
        ctx.save();
        ctx.translate(node.x, node.y);
        ctx.strokeStyle = '#ddd';
        ctx.lineWidth = 1;
        for (let i = 0; i < maxLayers; i++) {
          ctx.beginPath();
          ctx.arc(0, 0, baseRadius + i * ringSpacing, 0, 2 * Math.PI);
          ctx.stroke();
        }
        ctx.restore();
      } else {
        const size = node.size || 4;
        ctx.beginPath();
        ctx.arc(node.x, node.y, size, 0, 2 * Math.PI, false);
        ctx.fillStyle = node.color || '#666';
        ctx.fill();
      }
    })
    .onEngineStop(() => {
      Graph.zoom(Graph.zoom() * 0.5);
      Graph.centerAt(0, 0, 0);
    });

  const allCategories = [...new Set(entities.flatMap(e => e.categories))];
  const allImpacts = [...new Set(entities.flatMap(e => e.impacts))];

  function createFilterList(containerId, filterType, values) {
    const container = document.getElementById(containerId);
    values.forEach(value => {
      const item = document.createElement('div');
      item.className = 'filter-item';
      item.textContent = value;
      item.dataset.type = filterType;
      item.dataset.value = value;
      item.onclick = (e) => {
        const isActive = item.classList.contains('active');
        if (filterType === 'category') {
          document.querySelectorAll('.filter-item[data-type="category"]').forEach(el => el.classList.remove('active'));
          if (!isActive) {
            item.classList.add('active');
            showEntityList(item.dataset.value, item, e);
          } else {
            hideEntityList();
          }
        } else {
          item.classList.toggle('active');
        }
        applyFilters();
      };
      container.appendChild(item);
    });
  }

  createFilterList('categoryFilters', 'category', allCategories);
  createFilterList('impactFilters', 'impact', allImpacts);

  function getActiveFilters(type) {
    return [...document.querySelectorAll(`.filter-item.active[data-type="${type}"]`)].map(el => el.dataset.value);
  }

  function applyFilters() {
    const selectedCategories = getActiveFilters('category');
    const selectedImpacts = getActiveFilters('impact');

    const radialToInclude = new Set();

    nodes.forEach(n => {
      if (!n.name) return;
      const catMatch = selectedCategories.length === 0 || selectedCategories.some(cat => n.categories.includes(cat));
      const impMatch = selectedImpacts.length === 0 || selectedImpacts.includes(n.impact);
      if (catMatch && impMatch) radialToInclude.add(n.radialIndex);
    });

    const filteredNodes = nodes.filter(n =>
      n.id === centerNodeId || (n.radialIndex !== undefined && radialToInclude.has(n.radialIndex))
    );

    const nodeMap = new Map(filteredNodes.map(n => [n.id, n]));
    const filteredLinks = links
      .filter(link => nodeMap.has(link.source.id ?? link.source) && nodeMap.has(link.target.id ?? link.target))
      .map(link => ({
        source: nodeMap.get(link.source.id ?? link.source),
        target: nodeMap.get(link.target.id ?? link.target),
        radialIndex: link.radialIndex
      }));

    Graph.graphData({ nodes: filteredNodes, links: filteredLinks });

    const entityListContainer = document.getElementById('entityList');
    entityListContainer.innerHTML = '';

    if (selectedCategories.length === 1 && selectedImpacts.length === 0) {
      const selectedCategory = selectedCategories[0];
      const matchingEntities = entities.filter(e => e.categories.includes(selectedCategory)).map(e => e.name);

      matchingEntities.forEach(name => {
        const item = document.createElement('div');
        item.className = 'entity-item';
        item.textContent = name;
        item.onclick = () => {
          filterToEntity(name);
        };
        entityListContainer.appendChild(item);
      });

      entityListContainer.style.display = 'block';
    } else {
      entityListContainer.style.display = 'none';
    }
  }

  function showEntityList(category, clickedElement, event) {
    const matchingEntities = entities.filter(e => e.categories.includes(category));
    const entityListEl = document.getElementById('entityList');
    entityListEl.innerHTML = '';

    matchingEntities.forEach(entity => {
      const el = document.createElement('div');
      el.textContent = entity.name;
      el.onclick = () => filterToEntity(entity.name);
      entityListEl.appendChild(el);
    });

    const rect = clickedElement.getBoundingClientRect();
    entityListEl.style.left = `${rect.right + 10}px`;
    entityListEl.style.top = `${rect.top + window.scrollY}px`;
    entityListEl.style.display = 'block';
  }

  function hideEntityList() {
    document.getElementById('entityList').style.display = 'none';
  }

  function filterToEntity(name) {
    const targetEntity = entities.find(e => e.name === name);
    if (!targetEntity) return;

    const radialIndex = entities.findIndex(e => e.name === name);
    const filteredNodes = nodes.filter(n => n.id === centerNodeId || n.radialIndex === radialIndex);

    const nodeMap = new Map(filteredNodes.map(n => [n.id, n]));
    const filteredLinks = links
      .filter(link => nodeMap.has(link.source.id ?? link.source) && nodeMap.has(link.target.id ?? link.target))
      .map(link => ({
        source: nodeMap.get(link.source.id ?? link.source),
        target: nodeMap.get(link.target.id ?? link.target),
        radialIndex: link.radialIndex
      }));

    Graph.graphData({ nodes: filteredNodes, links: filteredLinks });

    // ✅ FIXED: Show info popup when clicking from list
    showInfoPopup(targetEntity);
  }

  function showInfoPopup(entity) {
    const popup = document.getElementById('infoPopup');
    document.getElementById('popupName').textContent = entity.name;
    document.getElementById('popupCategory').textContent = `Category: ${entity.categories.join(', ')}`;
    document.getElementById('popupImpact').textContent = `Impact: ${entity.impacts.join(', ')}`;
    popup.style.display = 'block';
  }
</script>
</body>
</html>
